<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard IoT ESP32 - DHT22 + LDR + Relay</title>
  <!-- MQTT.js CDN -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0f172a;
      color: white;
      text-align: center;
      padding: 20px;
    }
    h1 { color: #22d3ee; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px auto;
      max-width: 900px;
    }
    .card {
      background: #1e293b;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
    .value {
      font-size: 2em;
      color: #a5b4fc;
    }
    .timestamp {
      font-size: 0.85em;
      color: #94a3b8;
      margin-top: 8px;
    }
    button {
      background: #22d3ee;
      border: none;
      color: #0f172a;
      padding: 10px 25px;
      margin: 8px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { background: #67e8f9; }
    canvas {
      max-width: 700px;
      margin: 30px auto;
      background: #1e293b;
      padding: 15px;
      border-radius: 12px;
    }
    /* Section data terbaru */
    .data-feed {
      max-width: 900px;
      margin: 30px auto;
      background: #1e293b;
      border-radius: 15px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
    }
    .data-feed h2 {
      color: #22d3ee;
      margin-bottom: 15px;
    }
    .data-item {
      background: #0f172a;
      border-left: 4px solid #22d3ee;
      padding: 12px 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      animation: slideIn 0.3s ease-out;
    }
    .data-item.new {
      animation: pulse 0.5s ease-in-out;
    }
    .data-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }
    .data-item-topic {
      font-weight: bold;
      color: #22d3ee;
    }
    .data-item-time {
      font-size: 0.85em;
      color: #94a3b8;
    }
    .data-item-content {
      color: #e2e8f0;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    @keyframes pulse {
      0%, 100% { background: #0f172a; }
      50% { background: #1e3a5f; }
    }
    /* Scrollbar styling */
    .data-feed::-webkit-scrollbar {
      width: 8px;
    }
    .data-feed::-webkit-scrollbar-track {
      background: #0f172a;
      border-radius: 10px;
    }
    .data-feed::-webkit-scrollbar-thumb {
      background: #22d3ee;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h1>üì° Dashboard IoT ESP32 (DHT22 + LDR + Relay)</h1>

  <div class="grid">
    <div class="card">
      <h2>üå°Ô∏è Suhu</h2>
      <div class="value" id="suhuValue">-- ¬∞C</div>
      <div class="timestamp" id="suhuTime">Menunggu data...</div>
    </div>
    <div class="card">
      <h2>üíß Kelembapan</h2>
      <div class="value" id="humidValue">-- %</div>
      <div class="timestamp" id="humidTime">Menunggu data...</div>
    </div>
    <div class="card">
      <h2>üí° Kecerahan (LDR)</h2>
      <div class="value" id="ldrValue">-- %</div>
      <div class="timestamp" id="ldrTime">Menunggu data...</div>
    </div>
    <div class="card">
      <h2>‚öôÔ∏è Status Pompa</h2>
      <div class="value" id="pumpStatus">OFF</div>
      <button onclick="publishLED('on')">üîµ HIDUPKAN POMPA</button>
      <button onclick="publishLED('off')">‚ö´ MATIKAN POMPA</button>
    </div>
  </div>

  <!-- Section Data Terbaru -->
  <div class="data-feed">
    <h2>üìã Data Terbaru (Real-time Feed)</h2>
    <div id="dataFeedContainer">
      <div style="color: #94a3b8; text-align: center; padding: 20px;">
        Menunggu data dari ESP32...
      </div>
    </div>
  </div>

  <canvas id="chartCanvas"></canvas>

  <script>
    // ===============================
    // ‚öôÔ∏è Konfigurasi MQTT
    // ===============================
    const broker = "wss://broker.hivemq.com:8884/mqtt";
    const topicSuhu = "coba/suhu";
    const topicLDR  = "coba/ldr";
    const topicLED  = "coba/led";

    const client = mqtt.connect(broker);
    const apiURL = "http://localhost:3000/api/insert"; // üîó Node.js API

    // ===============================
    // üìä Setup Chart
    // ===============================
    const ctx = document.getElementById("chartCanvas").getContext("2d");
    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Suhu (¬∞C)",
            data: [],
            borderColor: "#22d3ee",
            fill: false,
            tension: 0.3
          },
          {
            label: "Kelembapan (%)",
            data: [],
            borderColor: "#34d399",
            fill: false,
            tension: 0.3
          },
          {
            label: "Kecerahan (%)",
            data: [],
            borderColor: "#facc15",
            fill: false,
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: "Waktu (detik)" }, ticks: { color: "#cbd5e1" } },
          y: { beginAtZero: true, title: { display: true, text: "Nilai" }, ticks: { color: "#cbd5e1" } }
        },
        plugins: {
          legend: { labels: { color: "#e2e8f0" } }
        }
      }
    });

    // ===============================
    // üîå MQTT Connection
    // ===============================
    client.on("connect", () => {
      console.log("‚úÖ Terhubung ke broker MQTT!");
      client.subscribe([topicSuhu, topicLDR]);
      console.log("üì° Subscribe ke:", topicSuhu, "dan", topicLDR);
    });

    // ===============================
    // üì© Saat pesan masuk dari MQTT
    // ===============================
    client.on("message", (topic, payload) => {
      const msg = payload.toString();
      console.log("üì©", topic, msg);
      try {
        const data = JSON.parse(msg);
        const now = new Date();
        const timeStr = now.toLocaleTimeString('id-ID');

        if (topic === topicSuhu) {
          const suhu = data.temperature;
          const hum = data.humidity;
          document.getElementById("suhuValue").textContent = suhu.toFixed(1) + " ¬∞C";
          document.getElementById("humidValue").textContent = hum.toFixed(1) + " %";
          document.getElementById("suhuTime").textContent = "Diperbarui: " + timeStr;
          document.getElementById("humidTime").textContent = "Diperbarui: " + timeStr;
          updateChart(suhu, hum, null);
          addDataFeedItem(topic, `Suhu: ${suhu.toFixed(1)}¬∞C, Kelembapan: ${hum.toFixed(1)}%`, timeStr);

          // üîÅ Kirim ke server otomatis
          sendToDatabase(suhu, hum, null);
        } 
        else if (topic === topicLDR) {
          const bright = data.brightness;
          document.getElementById("ldrValue").textContent = bright.toFixed(1) + " %";
          document.getElementById("ldrTime").textContent = "Diperbarui: " + timeStr;
          updateChart(null, null, bright);
          addDataFeedItem(topic, `Kecerahan: ${bright.toFixed(1)}%`, timeStr);

          // üîÅ Update lux terakhir ke database
          sendToDatabase(null, null, bright);
        }
      } catch (e) {
        console.warn("‚ö†Ô∏è Data tidak valid:", e);
      }
    });

    // ===============================
    // üì§ Publish ke LED / Relay
    // ===============================
    function publishLED(cmd) {
      client.publish(topicLED, cmd);
      console.log("üì§ Kirim ke LED:", cmd);
      const pump = document.getElementById("pumpStatus");
      pump.textContent = cmd === "on" ? "ON" : "OFF";
      pump.style.color = cmd === "on" ? "#22d3ee" : "#f87171";
    }

    // ===============================
    // üìà Update Grafik
    // ===============================
    let time = 0;
    function updateChart(suhu, hum, ldr) {
      time += 2;
      chart.data.labels.push(time.toString());
      if (suhu !== null) chart.data.datasets[0].data.push(suhu);
      if (hum !== null) chart.data.datasets[1].data.push(hum);
      if (ldr !== null) chart.data.datasets[2].data.push(ldr);
      if (chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets.forEach(ds => ds.data.shift());
      }
      chart.update();
    }

    // ===============================
    // üìã Tambah Item ke Data Feed
    // ===============================
    function addDataFeedItem(topic, content, time) {
      const container = document.getElementById("dataFeedContainer");
      
      // Hapus pesan "Menunggu data..." jika ada
      if (container.children.length === 1 && container.children[0].textContent.includes("Menunggu")) {
        container.innerHTML = '';
      }

      // Buat elemen data baru
      const item = document.createElement('div');
      item.className = 'data-item new';
      
      const topicIcon = topic.includes('suhu') ? 'üå°Ô∏è' : 'üí°';
      const topicColor = topic.includes('suhu') ? '#22d3ee' : '#facc15';
      
      item.innerHTML = `
        <div class="data-item-header">
          <span class="data-item-topic" style="color: ${topicColor}">${topicIcon} ${topic}</span>
          <span class="data-item-time">${time}</span>
        </div>
        <div class="data-item-content">${content}</div>
      `;
      
      // Tambahkan di awal (data terbaru di atas)
      container.insertBefore(item, container.firstChild);
      
      // Hapus animasi pulse setelah 500ms
      setTimeout(() => item.classList.remove('new'), 500);
      
      // Batasi maksimal 50 item
      while (container.children.length > 50) {
        container.removeChild(container.lastChild);
      }
    }

    // ===============================
    // üì® Kirim Data ke Database (Node.js)
    // ===============================
    async function sendToDatabase(suhu, humidity, lux) {
      try {
        const res = await fetch(apiURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ suhu, humidity, lux })
        });
        const data = await res.json();
        if (data.success) {
          console.log("‚úÖ Data tersimpan di database:", data.message);
        } else {
          console.warn("‚ö†Ô∏è Gagal simpan:", data.message);
        }
      } catch (err) {
        console.error("‚ùå Error kirim data ke server:", err);
      }
    }
  </script>
</body>
</html>
